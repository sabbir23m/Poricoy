<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poricoy Pro Admin - V7.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root { --main: #f85606; --dark: #121212; }
        body { font-family: 'Inter', sans-serif; transition: 0.3s; }
        .dark-mode { background: var(--dark); color: #fff; }
        .dark-mode .card { background: #1e1e1e !important; border-color: #333 !important; }
        .dark-mode input, .dark-mode select, .dark-mode textarea { background: #2d2d2d !important; border-color: #444 !important; color: #fff !important; }
        .loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; color: #fff; }
        .login-overlay { position: fixed; inset: 0; background: #f85606; z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .tab-btn.active { border-bottom: 3px solid #f85606; color: #f85606; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- LOGIN PANEL -->
    <div id="login-panel" class="login-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-80 text-center">
            <h2 class="text-2xl font-black text-orange-600 mb-6 italic">PORICOY ADMIN</h2>
            <input type="text" id="user" placeholder="User ID" class="w-full p-3 border rounded-xl mb-4 outline-none text-black">
            <input type="password" id="pass" placeholder="Password" class="w-full p-3 border rounded-xl mb-6 outline-none text-black">
            <button onclick="doLogin()" class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">ENTER PANEL</button>
            <p id="l-err" class="text-red-500 text-xs mt-3 hidden font-bold">Invalid Admin Access!</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="loader" class="loader">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-orange-500 mb-4"></div>
            <p id="status-msg" class="font-bold text-sm">Processing...</p>
        </div>

        <!-- Header -->
        <header class="bg-white p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center border-b card">
            <h1 class="font-black text-orange-600 italic">PORICOY ADMIN</h1>
            <div class="flex gap-4 items-center">
                <i class="fas fa-moon text-gray-500 cursor-pointer" onclick="toggleDark()"></i>
                <button onclick="handleAuth()" id="authBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold">CONNECT GOOGLE</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="bg-white flex border-b sticky top-[61px] z-40 card">
            <button onclick="setTab('add')" id="b-add" class="tab-btn active flex-1 py-3 text-xs font-bold uppercase">Add Product</button>
            <button onclick="setTab('manage'); fetchPosts();" id="b-manage" class="tab-btn flex-1 py-3 text-xs font-bold uppercase text-gray-400">Inventory</button>
        </div>

        <div class="p-4 max-w-xl mx-auto">
            <!-- ADD SECTION -->
            <div id="view-add" class="space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border card">
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Product Title *</label>
                            <input type="text" id="title" class="w-full p-3 border rounded-xl outline-none focus:border-orange-500 shadow-sm" placeholder="Enter shoe name">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Selling Price *</label>
                                <input type="number" id="price" placeholder="৳" class="w-full p-3 border rounded-xl outline-none shadow-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Discount Info (Optional)</label>
                                <input type="number" id="discount" placeholder="Save ৳" class="w-full p-3 border rounded-xl outline-none shadow-sm">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Category Selection *</label>
                            <div class="flex gap-1">
                                <select id="cat-select" class="flex-1 p-3 border rounded-xl outline-none bg-gray-50 text-xs font-bold shadow-sm"></select>
                                <button onclick="addCat()" class="bg-black text-white px-4 rounded-xl shadow-md"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Sizes (38,39,40...)</label>
                                <input type="text" id="sizes" class="w-full p-3 border rounded-xl outline-none shadow-sm" placeholder="Available sizes">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Colors (Text only)</label>
                                <input type="text" id="colors-text" class="w-full p-3 border rounded-xl outline-none shadow-sm" placeholder="Black, Red, White">
                            </div>
                        </div>

                        <!-- Photo Section -->
                        <div class="p-4 border rounded-xl bg-gray-50 card">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Main Photos (Upload Multiple)</label>
                            <input type="file" id="main-photos" multiple accept="image/*" class="w-full text-xs">
                        </div>

                        <div class="p-4 border border-orange-100 rounded-xl bg-orange-50/20 card">
                            <label class="text-[10px] font-bold text-orange-600 uppercase block mb-2">Color-Specific Photo Variants</label>
                            <div id="v-list"></div>
                            <button onclick="addV()" class="w-full py-2 bg-white text-orange-600 border border-orange-200 rounded-xl text-[10px] font-bold uppercase mt-2 shadow-sm">+ Add Variant Image</button>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Description</label>
                            <textarea id="description" rows="3" class="w-full p-3 border rounded-xl outline-none shadow-sm" placeholder="Product details..."></textarea>
                        </div>

                        <button onclick="publish()" id="publish-btn" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">PUBLISH PRODUCT</button>
                    </div>
                </div>
            </div>

            <!-- MANAGE SECTION -->
            <div id="view-manage" class="hidden space-y-3">
                <div id="post-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const BLOG_ID = '1102146600159472315';
        const CLIENT_ID = '391679215430-eug336ehuuup6rkl61lsa7fm7p9gnmnp.apps.googleusercontent.com';

        // 1. Fixed Security Login
        function doLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(u === 'sabbir23m' && p === 'poricoy23m') {
                localStorage.setItem('auth_poricoy', 'true');
                location.reload();
            } else {
                document.getElementById('l-err').classList.remove('hidden');
            }
        }
        if(localStorage.getItem('auth_poricoy') === 'true') {
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        // 2. Fixed Category Management (Persistent)
        let cats = JSON.parse(localStorage.getItem('my_cats')) || ["Sneakers", "Formal", "Loafers", "Sports"];
        function renderCats() {
            const sel = document.getElementById('cat-select');
            sel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        renderCats();

        function addCat() {
            const n = prompt("Enter New Category Name:");
            if(n) {
                if(!cats.includes(n)) {
                    cats.push(n);
                    localStorage.setItem('my_cats', JSON.stringify(cats));
                    renderCats();
                    document.getElementById('cat-select').value = n;
                } else {
                    alert("Category already exists!");
                }
            }
        }

        // 3. Dark Mode
        function toggleDark() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('dark_theme', document.body.classList.contains('dark-mode'));
        }
        if(localStorage.getItem('dark_theme') === 'true') document.body.classList.add('dark-mode');

        // 4. Blogger Authentication
        let token = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        if(token) {
            document.getElementById('authBtn').innerText = "✅ CONNECTED";
            document.getElementById('authBtn').classList.replace('bg-blue-600', 'bg-green-600');
        }
        function handleAuth() {
            const uri = window.location.origin + window.location.pathname;
            const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(uri)}&response_type=token&scope=https://www.googleapis.com/auth/blogger`;
            window.location.assign(url);
        }

        // 5. Variant Logic
        let vId = 0;
        function addV() {
            vId++;
            const div = `
                <div class="flex items-center gap-2 mb-2 bg-white p-2 rounded-lg border card" id="v-row-${vId}">
                    <input type="text" placeholder="Color Name" class="v-name p-2 text-[10px] border rounded w-24 uppercase font-bold text-black">
                    <input type="file" class="v-file text-[8px] flex-1">
                    <button onclick="document.getElementById('v-row-${vId}').remove()" class="text-red-500 px-2"><i class="fas fa-trash"></i></button>
                </div>
            `;
            document.getElementById('v-list').insertAdjacentHTML('beforeend', div);
        }

        // 6. Tab System
        function setTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('b-'+t).classList.add('active');
            document.getElementById('view-add').style.display = t === 'add' ? 'block' : 'none';
            document.getElementById('view-manage').style.display = t === 'manage' ? 'block' : 'none';
        }

        // 7. Core Publish Function (Fixed)
        async function publish() {
            if(!token) return alert("Error: Connect to Google/Blogger first!");
            const t = document.getElementById('title').value;
            const pr = document.getElementById('price').value;
            const ct = document.getElementById('cat-select').value;
            const mainPh = document.getElementById('main-photos').files;

            if(!t || !pr || mainPh.length === 0) {
                alert("Wait! Title, Price and at least one Photo are mandatory.");
                return;
            }

            document.getElementById('loader').style.display = 'flex';
            let gallery = "";
            let colorString = document.getElementById('colors-text').value;

            try {
                // Upload General Photos
                document.getElementById('status-msg').innerText = "Step 1: Uploading Main Photos...";
                for(let f of mainPh) {
                    const fd = new FormData(); fd.append('file', f);
                    const res = await fetch('https://telegra.ph/upload', { method: 'POST', body: fd });
                    const img = await res.json();
                    gallery += `<img src="https://telegra.ph${img[0].src}" class="p-img-item"/>`;
                }

                // Upload Color Variants
                document.getElementById('status-msg').innerText = "Step 2: Uploading Variants...";
                const rows = document.querySelectorAll('[id^="v-row-"]');
                for(let r of rows) {
                    const cN = r.querySelector('.v-name').value;
                    const cF = r.querySelector('.v-file').files[0];
                    if(cN && cF) {
                        const fd = new FormData(); fd.append('file', cF);
                        const res = await fetch('https://telegra.ph/upload', { method: 'POST', body: fd });
                        const img = await res.json();
                        gallery += `<img src="https://telegra.ph${img[0].src}" data-color="${cN}" class="p-img-item-var"/>`;
                        colorString += (colorString ? "," : "") + cN;
                    }
                }

                // Metadata Creation
                const allSizes = document.getElementById('sizes').value;
                const disc = document.getElementById('discount').value;
                const desc = document.getElementById('description').value;

                const finalHTML = `
                    <div class="product-data" style="display:none">
                        <span class="sizes">${allSizes}</span>
                        <span class="colors">${colorString}</span>
                        <span class="discount">${disc}</span>
                    </div>
                    ${pr}
                    <div class="gallery-wrap">${gallery}</div>
                    <p class="desc">${desc}</p>
                `;

                // Post to Blogger API
                document.getElementById('status-msg').innerText = "Step 3: Saving to Website...";
                const blogRes = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        "title": t, 
                        "content": finalHTML, 
                        "labels": [ct, "LiveProduct"] 
                    })
                });

                if(blogRes.ok) {
                    alert("AWESOME! Product is now Live on your Website.");
                    location.reload();
                } else {
                    alert("Oops! Blogger rejected the post. Try connecting again.");
                }

            } catch (err) {
                alert("CRITICAL ERROR: Failed to upload. Check internet.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Manage/Inventory Logic
        async function fetchPosts() {
            if(!token) return;
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            const list = document.getElementById('post-list');
            if(!data.items) { list.innerHTML = "Empty Inventory."; return; }
            list.innerHTML = data.items.map(p => `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center card">
                    <span class="text-[10px] font-bold truncate flex-1 mr-4">${p.title}</span>
                    <button onclick="del('${p.id}')" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function del(id) {
            if(!confirm("Remove this shoe from website?")) return;
            document.getElementById('loader').style.display = 'flex';
            await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
            });
            fetchPosts();
            document.getElementById('loader').style.display = 'none';
        }
    </script>
</body>
</html>